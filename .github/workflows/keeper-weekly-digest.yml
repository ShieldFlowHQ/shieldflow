name: Keeper Weekly Digest

on:
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch:

permissions:
  issues: write
  pull-requests: read

jobs:
  digest:
    runs-on: ubuntu-latest
    steps:
      - name: Publish weekly triage digest issue
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const openIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              per_page: 100,
            });

            const issuesOnly = openIssues.filter((i) => !i.pull_request);
            const prsOnly = openIssues.filter((i) => i.pull_request);

            const needsTriage = issuesOnly.filter((i) =>
              i.labels.some((l) => l.name === "status/needs-triage"),
            ).length;

            const week = new Date().toISOString().slice(0, 10);
            const title = `Keeper Weekly Digest - ${week}`;
            const marker = "<!-- keeper-weekly-digest -->";

            const body = `${marker}\n# ðŸ›¡ï¸ Keeper Weekly Digest (${week})\n\n## Backlog snapshot\n- Open issues: **${issuesOnly.length}**\n- Open PRs: **${prsOnly.length}**\n- Needs triage: **${needsTriage}**\n\n## Suggested focus\n1. Triage items labeled \`status/needs-triage\`\n2. Unblock anything tagged \`status/blocked\`\n3. Prioritize \`priority/high\` before backlog gardening\n\n_This digest is auto-generated by Keeper so humans can spend more time shipping and less time counting._`;

            const existing = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              per_page: 100,
              creator: "github-actions[bot]",
            });

            const match = existing.find((i) => i.title === title && i.body?.includes(marker));

            if (match) {
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: match.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner,
                repo,
                title,
                body,
                labels: ["type/chore", "area/ci"],
              });
            }
