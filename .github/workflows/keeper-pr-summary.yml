name: Keeper PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Create or update PR summary comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = "<!-- keeper-pr-summary -->";

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changed = files.length;
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);

            const body = `${marker}\nðŸ§­ **Keeper PR Snapshot**\n\n- Files changed: **${changed}**\n- Additions: **+${additions}**\n- Deletions: **-${deletions}**\n\nFriendly nudge: call out security-sensitive changes and rollback notes in the PR description. Future incident-you will be grateful.`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user?.type === "Bot" && c.body?.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body,
              });
            }
