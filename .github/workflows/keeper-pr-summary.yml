name: Keeper PR Summary

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write

jobs:
  summary:
    runs-on: ubuntu-latest
    steps:
      - name: Create or update PR summary comment
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const marker = "<!-- keeper-pr-summary -->";

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr.number,
              per_page: 100,
            });

            const changed = files.length;
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);

            const sassOpeners = [
              "Serving fresh PR tea â˜•",
              "Keeper has entered the chat with receipts ðŸ§¾",
              "Another PR? Delightful. Let's poke it with a stick ðŸª„",
              "Build goblins inspected this diff and survived ðŸ§Œ",
            ];

            const sassNudges = [
              "If this touches security and the PR description is vague, that's character development (the bad kind).",
              "Rollback notes are hot. Missing rollback notes are... an adventure.",
              "Please document blast radius before future-you files a complaint with present-you.",
              "Tiny reminder: 'works on my machine' is not a deployment strategy.",
            ];

            const opener = sassOpeners[(pr.number + changed) % sassOpeners.length];
            const nudge = sassNudges[(additions + deletions) % sassNudges.length];

            const body = `${marker}\nðŸ§­ **Keeper PR Snapshot**\n\n_${opener}_\n\n- Files changed: **${changed}**\n- Additions: **+${additions}**\n- Deletions: **-${deletions}**\n\nðŸ’… **Sassy but serious reminder:** call out security-sensitive changes and rollback notes in the PR description.\n${nudge}`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100,
            });

            const existing = comments.find(
              (c) => c.user?.type === "Bot" && c.body?.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr.number,
                body,
              });
            }
