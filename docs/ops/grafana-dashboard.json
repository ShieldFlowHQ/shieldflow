{
  "__inputs": [
    {
      "name": "DS_PROMETHEUS",
      "label": "Prometheus",
      "description": "Prometheus datasource scraping ShieldFlow /metrics",
      "type": "datasource",
      "pluginId": "prometheus",
      "pluginName": "Prometheus"
    }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "9.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
    { "type": "panel", "id": "table", "name": "Table", "version": "" },
    { "type": "panel", "id": "piechart", "name": "Pie chart", "version": "" }
  ],
  "id": null,
  "uid": "shieldflow-security-v1",
  "title": "ShieldFlow Security Dashboard",
  "tags": ["shieldflow", "security", "proxy"],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "30s",
  "time": { "from": "now-24h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "query": "prometheus",
        "label": "Prometheus",
        "current": {},
        "hide": 0,
        "includeAll": false,
        "multi": false
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "stat",
      "title": "Total Requests",
      "description": "Total proxy requests received since startup.",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "orientation": "auto",
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      },
      "fieldConfig": {
        "defaults": { "color": { "mode": "palette-classic" }, "unit": "short" }
      },
      "targets": [
        {
          "expr": "shieldflow_requests_total",
          "legendFormat": "Requests",
          "refId": "A"
        }
      ]
    },
    {
      "id": 2,
      "type": "stat",
      "title": "Total Blocked",
      "description": "Total tool calls blocked since startup.",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          }
        }
      },
      "targets": [
        {
          "expr": "sum(shieldflow_decisions_total{decision=\"BLOCK\"}) or vector(0)",
          "legendFormat": "Blocked",
          "refId": "A"
        }
      ]
    },
    {
      "id": 3,
      "type": "stat",
      "title": "Awaiting Confirmation",
      "description": "Total tool calls flagged for confirmation.",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "unit": "short",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 }
            ]
          }
        }
      },
      "targets": [
        {
          "expr": "sum(shieldflow_decisions_total{decision=\"CONFIRM\"}) or vector(0)",
          "legendFormat": "Confirm",
          "refId": "A"
        }
      ]
    },
    {
      "id": 4,
      "type": "stat",
      "title": "Block Rate (5m)",
      "description": "Blocked decisions per minute over the last 5 minutes.",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] } },
      "fieldConfig": {
        "defaults": { "unit": "reqpm", "decimals": 1 }
      },
      "targets": [
        {
          "expr": "rate(shieldflow_decisions_total{decision=\"BLOCK\"}[5m]) * 60",
          "legendFormat": "blocks/min",
          "refId": "A"
        }
      ]
    },
    {
      "id": 5,
      "type": "timeseries",
      "title": "Validation Decisions (rate/min)",
      "description": "Block, allow, and confirm rates over time.",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": {
        "legend": { "calcs": ["sum"], "displayMode": "table", "placement": "bottom" },
        "tooltip": { "mode": "multi", "sort": "none" }
      },
      "fieldConfig": {
        "defaults": { "unit": "reqpm", "custom": { "lineWidth": 2 } },
        "overrides": [
          { "matcher": { "id": "byName", "options": "BLOCK" },
            "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }]
          },
          { "matcher": { "id": "byName", "options": "ALLOW" },
            "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }]
          },
          { "matcher": { "id": "byName", "options": "CONFIRM" },
            "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }]
          }
        ]
      },
      "targets": [
        {
          "expr": "sum by (decision) (rate(shieldflow_decisions_total[5m]) * 60)",
          "legendFormat": "{{decision}}",
          "refId": "A"
        }
      ]
    },
    {
      "id": 6,
      "type": "piechart",
      "title": "Decision Mix",
      "description": "Overall block/allow/confirm ratio since startup.",
      "gridPos": { "h": 8, "w": 6, "x": 12, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" },
        "pieType": "donut"
      },
      "targets": [
        {
          "expr": "sum by (decision) (shieldflow_decisions_total)",
          "legendFormat": "{{decision}}",
          "refId": "A",
          "instant": true
        }
      ]
    },
    {
      "id": 7,
      "type": "piechart",
      "title": "Trust Distribution (Blocks)",
      "description": "Breakdown of BLOCK decisions by trigger trust level.",
      "gridPos": { "h": 8, "w": 6, "x": 18, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": {
        "legend": { "displayMode": "table", "placement": "right" },
        "pieType": "pie"
      },
      "targets": [
        {
          "expr": "sum by (trigger_trust) (shieldflow_decisions_total{decision=\"BLOCK\"})",
          "legendFormat": "{{trigger_trust}}",
          "refId": "A",
          "instant": true
        }
      ]
    },
    {
      "id": 8,
      "type": "table",
      "title": "Top Blocked Patterns",
      "description": "Injection pattern categories that have triggered the most BLOCK decisions.",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": { "sortBy": [{ "displayName": "Value", "desc": true }] },
      "fieldConfig": {
        "defaults": { "custom": { "displayMode": "auto" } },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Value" },
            "properties": [
              { "id": "displayName", "value": "Block Count" },
              { "id": "custom.displayMode", "value": "color-background" },
              { "id": "color", "value": { "mode": "continuous-RdYlGn" } }
            ]
          }
        ]
      },
      "targets": [
        {
          "expr": "topk(15, shieldflow_blocked_patterns_total)",
          "legendFormat": "{{pattern}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": { "valueLabel": "pattern" } },
        { "id": "organize", "options": { "renameByName": { "Value": "Block Count" } } }
      ]
    },
    {
      "id": 9,
      "type": "table",
      "title": "Top Blocked Tools",
      "description": "Tool names most frequently blocked.",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "options": { "sortBy": [{ "displayName": "Value", "desc": true }] },
      "targets": [
        {
          "expr": "topk(10, sum by (tool) (shieldflow_decisions_total{decision=\"BLOCK\"}))",
          "legendFormat": "{{tool}}",
          "refId": "A",
          "instant": true,
          "format": "table"
        }
      ],
      "transformations": [
        { "id": "labelsToFields", "options": { "valueLabel": "tool" } },
        { "id": "organize", "options": { "renameByName": { "Value": "Block Count" } } }
      ]
    }
  ]
}
